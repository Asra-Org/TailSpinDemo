name: gitleaks-scan
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [master]
jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup Gitleaks
      run: |
        brew install gitleaks
    - name: Secret Scan
      run: |
        gitleaks detect -s ${{github.workspace}} -f csv -r output.csv
      continue-on-error: true      
    - name: Check file content
      id: report
      run: |
       if [ -s output.csv ]; then
         echo "ðŸ›‘ Leaks detected secrets ðŸ›‘"
         echo "::set-output name=secrets::1"
       else
         echo "âœ… No Secrets or credentials were found"
       fi
    - name: Upload Artifacts
      if: ${{steps.report.outputs.secrets}}
      uses: actions/upload-artifact@v3.1.0
      with:
        # Artifact name
        name: scan-report
        path: output.csv
    - name: Read CSV
      id: csv
      uses: juliangruber/read-file-action@v1
      with:
        path: ./output.csv
        
    - uses: petems/csv-to-md-table-action@master
      id: csv-table-output
      with:
        csvinput: ${{ steps.csv.outputs.content }}
        
    - name: Add PR comment
      if: (steps.report.outputs.secrets == 1 && github.event_name == 'pull_request')
      uses: mshick/add-pr-comment@v1
      with:
        message: |
          ðŸ›‘ Leaks detected secrets ðŸ›‘
          ${{steps.csv-table-output.outputs.markdown-table}}
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        repo-token-user-login: 'github-actions[bot]' # The user.login for temporary GitHub tokens
        allow-repeats: true
        
    - name: Failing the Action
      if: steps.report.outputs.secrets == 1 
      run: |
       echo "One ore more credentials are exposed"
       exit
